<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-image/iron-image.html">
<link rel="import" href="../iron-pages/iron-pages.html">
<link rel="import" href="../paper-spinner/paper-spinner-lite.html">

<link rel="import" href="../kwc-animations/kwc-particle-burst.html">
<link rel="import" href="../kwc-button/kwc-mega-button.html">
<link rel="import" href="../kwc-share-player/kwc-share-player.html">
<link rel="import" href="../kwc-social-comments/kwc-social-comments.html">
<link rel="import" href="../kwc-style/kwc-style.html">
<link rel="import" href="../kwc-icons/kwc-icons.html">
<!-- Import svg definition as data:uri -->
<link rel="import" href="assets.html">

<!--
`kwc-share-detail` 
To display details specific to a kano code share.

@demo demo/index.html
-->

<dom-module id="kwc-share-detail">
    <template>
        <style>
            @keyframes fade-in {
                from {
                    opacity: 0;
                }
                to {
                    opacity: 1;
                }
            }

            :host {
                background-color: white;
                border-radius: 3px;
                display: block;
                overflow: hidden;
                font-family: var(--font-body);
                @apply --kw-share-detail;
            }

            :host * {
                box-sizing: border-box;
            }

            :host *[hidden] {
                display: none !important;
            }

            .share {
                @apply --layout-vertical;
                @apply --layout-center;
                display: flex;
                width: 100%;
            }

            .share>iron-image {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            .share-content {
                @apply --layout-flex;
                background: var(--kw-share-detail-share-background, var(--color-chateau));
                width: 100%;
                padding: 0px 16px;
                min-height: var(--kw-share-detail-player-height, 480px);
                height: var(--kw-share-detail-player-height, 480px);
                box-sizing: border-box;
                position: relative;
            }

            .share-content .loading {
                color: white;
                transition: opacity 200ms linear;
            }

            :host(.loaded) .share-content .loading {
                opacity: 0;
            }

            #share-container {
                animation: fade-in 200ms linear;
            }

            #share-container,
            .share-content .loading,
            .share-content .content,
            .share-content .content .featured,
            .share-content .loading iron-image,
            .share-content .loading .overlay {
                @apply --layout-fit;
            }

            .share-content .loading .overlay {
                @apply --layout-vertical;
                @apply --layout-center;
                @apply --layout-center-justified;
            }

            .share-content .content .featured,
            kwc-share-player {
                background-color: transparent;
                height: 100%;
                margin: 20px auto;
                max-width: 800px;
                width: 100%;
            }
            kwc-share-player{
                --kwc-share-player-height: 480px;
                position: relative;
                top:50px;
            }
            /* ::slotted(share-hardware) {
               position: absolute;
               bottom: 0;
            } */

            @media all and (max-width: 680px) {
                .share-content .content .featured,
                #share-container>* {
                    max-height: calc(100% - 120px);
                    padding: 0 20px;
                }
            }

            @media all and (min-width: 681px) {
                .share-content .content .featured,
                #share-container>* {
                    max-height: calc(100% - 100px);
                }
            }

            .featured-icon {
                height: 44px;
                margin-top: 7%;
                width: 44px;
            }

            .share-detail {
                @apply --layout-horizontal;
                max-width: var(--content-width);
                width: 100%;
            }

            .main-details {
                @apply --layout-flex-8;
                padding: 32px 40px 32px 8px;
            }

            .header {
                @apply --layout-horizontal;
            }

            .avatar-wrapper {
                flex: none;
                overflow: hidden;
                width: 40px;
                height: 40px;
                border-radius: 50%;
                position: relative;
                background-color: var(--color-sky);
            }

            .avatar {
                background-color: var(--color-sky);
                cursor: pointer;
                height: 45px;
                position: absolute;
                top: -2px;
                width: 40px;
            }

            .title {
                margin: 0;
                padding-bottom: 5px;
            }

            .title ::slotted(iron-icon) {
                height: 28px;
                margin-top: -10px;
                width: 28px;
            }

            .attribution {
                font-weight: normal;
                margin: 0;
                padding-bottom: 8px;
            }

            .author {
                color: var(--color-carnation);
                cursor: pointer;
                font-weight: bold;
            }

            .description {
                color: var(--color-chateau);
                line-height: 20px;
                margin: 0;
            }

            .description:not(:empty) {
                font-size: 16px;
                padding: 5px 0 24px 0;
            }

            .description:empty {
                padding-bottom: 16px;
            }

            .social-nav {
                @apply --layout-horizontal;
                border-bottom: 1px solid var(--color-porcelain);
                color: var(--color-grey);
                list-style: none;
                margin: 0;
                padding: 0 0 32px 60px;
            }

            .social-nav .nav-item {
                cursor: pointer;
                font-weight: bold;
                margin-right: 20px;
                position: relative;
            }

            .social-nav .nav-icon {
                margin-right: 8px;
                width: 16px;
            }

            .nav-item.active {
                color: black;
            }

            .nav-item.active .nav-icon {
                color: var(--color-sky);
            }

            .nav-item.active::after {
                background-color: white;
                border-left: 1px solid var(--color-porcelain);
                border-radius: 3px 0 0 0;
                border-top: 1px solid var(--color-porcelain);
                bottom: -40px;
                content: "";
                height: 16px;
                left: 0;
                margin: auto;
                position: absolute;
                right: 0;
                transform: rotate(45deg);
                width: 16px;
            }

            kw-social-comment {
                width: 100%;
            }

            .supplementary-details {
                @apply --layout-flex-4;
                border-left: 1px solid var(--color-porcelain);
                color: var(--color-grey);
                padding: 32px 8px 32px 40px;
            }
            kwc-mega-button {
                width: 65%;
            }
            .actions {
                @apply --layout-justified;
                margin-bottom: 36px;
            }
            .action {
                flex: 1 0 auto;
                box-sizing: border-box;
                margin-bottom: 10px;
            }
            .action-button.view-code{
                --kwc-mega-button-color: var(--color-dodger-blue);
            }
            .action-button.like{
                --kwc-mega-button-color: var(--color-carnation);
            }

            .like.liked {
                --kwc-mega-button-color: rgba(255, 255, 255, 1);
                --kwc-mega-button-bg-color: var(--color-carnation);
            }
            paper-spinner-lite {
                display: block;
                margin: auto;
                color: black;
                bottom: 39px;
            }
            .action-button.feature {
                color: white;
                margin-top: 32px;
                width: 100%;
            } 
            .action-button.feature.default {
                background-color: var(--color-chateau);
            }

            .action-button.feature.featured {
                background-color: var(--color-kano-orange);
            }

            .action-button.feature.default:hover {
                background-color: var(--color-orange);
            }

            .action-button.feature.featured:hover {
                background-color: var(--color-flame);
            }
            .social-actions {
                @apply --layout-horizontal;
                @apply --layout-start-justified;
                list-style: none;
                margin: 0;
                padding: 10px 0 0 0;
            }

            .social-action {
                box-sizing: border-box;
                margin-right: 16px;
            }

            .social-button {
                border: 0;
                border-radius: 3px;
                color: white;
                cursor: pointer;
                padding: 8px;
                text-transform: uppercase;
                transition: 0.3s ease;
            }

            .social-button:focus {
                outline: 0;
            }

            .social-button.facebook {
                background-color: var(--color-facebook);
            }

            .social-button.twitter {
                background-color: var(--color-twitter);
            }

            .social-button.email {
                background-color: var(--color-kano-orange);
            }

            .social-button .action-icon {
                height: 16px;
                width: 16px;
            }

            :host([tombstone]) .avatar,
            :host([tombstone]) .avatar-wrapper {
                background: var(--color-grey-lightest);
                color: transparent;
            }

            :host([tombstone]) .title {
                width: 200px;
                height: 22px;
                background: var(--color-grey-lightest);
                color: transparent;
            }

            :host([tombstone]) .attribution {
                position: relative;
                width: 100px;
                height: 16px;
                background: var(--color-grey-lightest);
                color: transparent;
                margin-top: 6px;
            }

            :host([tombstone]) .description {
                width: 100%;
                height: 36px;
                background: var(--color-grey-lightest);
                color: transparent;
                margin-top: 6px;
                margin-bottom: 12px;
            }

            :host([tombstone]) .supplementary-details,
            :host([tombstone]) #share-container,
            :host([tombstone]) .social {
                opacity: 0.3;
            }

            .detail {
                margin-left: 10px;
            }
        </style>
        <div id="share" class="share">
            <div class="share-content">
                <div class="loading">
                    <iron-image src="[[shareData.cover_url]]" sizing="contain"></iron-image>
                    <div class="overlay">
                        <h2>Loading</h2>
                    </div>
                </div>
                <div class="content">
                    <div class="featured" hidden$="[[!featured]]">
                        <iron-image class="featured-icon" src$="[[_featuredIconUrl]]" sizing="contain" preload fade></iron-image>
                    </div>
                    <div id="share-container">
                        <slot name="player::before"></slot>
                        <kwc-share-player share="[[shareData]]"
                                          display-code="{{displayCode}}">
                        </kwc-share-player>
                        <slot name="player::after"></slot>
                        <slot name="share-hardware"></slot>
                    </div>
                </div>
            </div>
            <div class="share-detail">
                <div class="main-details">
                    <div class="header">
                        <div class="avatar-wrapper">
                            <iron-image class="avatar" 
                                         src$="[[_avatarUrl]]"
                                         sizing="cover"
                                         on-tap="_onUserTapped"
                                         preload fade>
                                        </iron-image>
                        </div>
                        <div class="detail">
                            <h3 class="title">
                                <slot name="title-icon"></slot>
                                [[shareData.title]]
                            </h3>
                            <h4 class="attribution">by
                                <a class="author"
                                   on-tap="_onUserTapped">[[shareData.username]]
                                   </a>
                            </h4>
                            <p class="description">[[shareData.description]]</p>
                        </div>
                    </div>
                    <div class="social">
                        <ul class="social-nav">
                            <li class$="[[_computeNavItemClass(_section, 'comments')]]" on-click="_showComments">
                                <iron-icon class="nav-icon" icon="kwc-social-icons:comment"></iron-icon>
                                <span class="nav-label">[[comments.count]] Replies</span>
                            </li>
                            <li class$="[[_computeNavItemClass(_section, 'likes')]]">
                                <iron-icon class="nav-icon" icon="kwc-social-icons:like"></iron-icon>
                                <span class="nav-label">[[likes.length]] Likes</span>
                            </li>
                        </ul>
                        <!-- Set up with support for showing lists of
                                 likes and remixes in future, when the API support
                                 is available -->
                        <iron-pages id="social-sections"
                                    selected="[[_section]]"
                                    attr-for-selected="section-name"
                                    fallback-selection="comments">
                            <div section-name="comments" class="social-section">
                                <kwc-social-comments id="comments"
                                                     comments="[[comments.entries]]"
                                                     default-avatar="[[_defaultCommentAvatarUrl]]"
                                                     next-page="[[comments.page]]"
                                                     item-id="[[shareData.id]]"
                                                     tombstone$="[[!shareData]]"
                                                     user="[[currentUser]]"
                                                     loader-status="[[commentLoaderStatus]]"
                                                     on-load-comment="_handleLoadComment"
                                                     on-post-comment="_handlePostComment"
                                                     on-flag-comment="_handleFlagComment"
                                                     on-view-user="_handleViewUser">
                                                     </kwc-social-comments>
                            </div>
                        </iron-pages>
                    </div>
                </div>
                <div class="supplementary-details">
                    <div class="actions">
                        <slot name='actions::before'></slot>
                        <template is="dom-if" if="[[!_sharedByUser]]">
                            <div class="action">
                                <kwc-mega-button icon-id="kwc-social-icons:like"
                                                 class$="[[_computeLikeClass(liked)]]"
                                                 on-tap="_onLikeTapped">
                                    <kwc-particle-burst number-particles="40"
                                                        gravity="0.5"
                                                        particle-decay="0.04"
                                                        max-particle-size="13">
                                            [[_computedLikeButtonText(liked)]]
                                    </kwc-particle-burst>
                                    <paper-spinner-lite active="[[submitingLike]]">
                                    </paper-spinner-lite>
                                </kwc-mega-button>
                            </div>
                        </template>
                        <slot name='actions::one'></slot>                        
                        <template is="dom-if" if="[[_showRemixButton(shareData)]]">
                            <div class="action">
                                <kwc-mega-button icon-id="kwc-social-icons:code"
                                            class="action-button remix"
                                            on-tap="_onRemixTapped">
                                    Remix
                                </kwc-mega-button>
                            </div>
                        </template>
                        <slot name='actions::two'></slot>                                                
                        <template is="dom-if" if="[[_showCodeButton(shareData)]]">
                            <div class="action">
                                <kwc-mega-button icon-id="kwc-social-icons:code"
                                                 class="action-button view-code"
                                                 on-tap="_toggleCodeView">
                                    View Code
                                </kwc-mega-button>
                            </div>
                        </template>
                        <slot name='actions::three'></slot>                        
                        <template is="dom-if"
                                  if="[[_showFeaturedButton(shareData, currentUser.adminLevel)]]">
                            <div class="action">
                                <kwc-mega-button icon-id="kwc-social-icons:staff"
                                                 class$="[[_computeFeatureClass(shareData.featured)]]"
                                                 on-tap="_onFeatureTapped">
                                    Staff Pick
                                </kwc-mega-button>
                            <div>
                        </template>
                        <slot name='actions::after'></slot>                                                
                    </div>
                    <div class="social-actions-header">SHARE</div>
                    <ul class="social-actions">
                        <li class="social-action">
                            <button class="social-button facebook" on-tap="_onFacebookTapped">
                                <iron-icon class="action-icon" icon="kwc-social-icons:facebook"></iron-icon>
                            </button>
                        </li>
                        <li class="social-action">
                            <button class="social-button twitter" on-tap="_onTwitterTapped">
                                <iron-icon class="action-icon" icon="kwc-social-icons:twitter"></iron-icon>
                            </button>
                        </li>
                        <li class="social-action">
                            <button class="social-button email" on-tap="_onEmailTapped">
                                <iron-icon class="action-icon" icon="kwc-social-icons:share"></iron-icon>
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </template>

    <script>
        (function () {
            Polymer({

                is: 'kwc-share-detail',
                properties: {
                    shareData: {
                        type: Object
                    },
                    displayCode:{
                        type: Boolean,
                        value: false
                    },
                    loaded: {
                        type: Boolean,
                        value: false,
                        notify: true
                    },
                    _avatarUrl: {
                        type: String,
                        computed: '_computeAvatarUrl(shareData)'
                    },
                    comments: {
                        type: Object,
                        value: () => {
                            return {};
                        }
                    },
                    commentLoaderStatus: {
                        type: String,
                        computed: "_computeLoaderStatus(comments.*)"
                    },
                    _defaultCommentAvatarUrl: {
                        type: String,
                        value: () => {
                            return KwcShareDetail.assets.avatar;
                        }
                    },
                    featured: {
                        type: Boolean,
                        value: false,
                        reflectToAtrribute: true
                    },
                    featuredIconUrl: {
                        type: String,
                        value: null
                    },
                    _featuredIconUrl: {
                        type: String,
                        computed: '_computeFeaturedIconUrl(featuredIconUrl)'
                    },
                    currentUser: {
                        type: Object,
                        value: () => {
                            return {};
                        }
                    },
                    _section: {
                        type: String,
                        value: "comments"
                    },
                    likes: {
                        type: Array,
                        value: () => {
                            return [];
                        }
                    },
                    liked: {
                        type: Boolean,
                        computed: '_computeLiked(likes.*, currentUser)'
                    },
                    /* Property to indicate whether we are currently submiting a like request*/
                    submitingLike: {
                        type: Boolean,
                        value: false
                    },
                    _sharedByUser: {
                        type: Boolean,
                        computed: '_computeSharedByUser(shareData, currentUser)'
                    }
                },
                observers: [
                    '_shareDataChanged(shareData.*)'
                ],
                /** Computed values*/
                _computeAvatarUrl(shareData) {
                    if (shareData) {
                        if (shareData.userAvatar) {
                            return shareData.userAvatar;
                        } else {
                            return KwcShareDetail.assets.avatar;
                        }
                    } else {
                        /** No share provided, don't set the avatar */
                        return ''; //Valid URI
                    }
                },
                _computeLoaderStatus(commentChangeObj){
                    let comments = commentChangeObj.base;
                    if (comments){
                        return comments.page ? "on" : "off";
                    } else {
                        return "off";
                    }
                },
                _computeFeaturedIconUrl() {
                    if (this.featuredIconUrl) {
                        return this.featuredIconUrl;
                    }
                    return (KwcShareDetail && KwcShareDetail.assets)
                        ? KwcShareDetail.assets.featured
                        : ''; //Valid URI
                },
                _computeFeatureClass (featured) {
                    let baseClass = 'action-button feature',
                        activeClass = featured ? 'featured' : 'default';
                    return `${baseClass} ${activeClass}`;
                },
                _computeSharedByUser (shareData, currentUser) {
                    if (!shareData || !currentUser) {
                        return false;
                    }
                    return shareData.userId === currentUser.id;
                },
                _computeLiked (likeChangeObj, currentUser) {
                    let likes = likeChangeObj.base;
                    if (likes && likes.length && currentUser) {
                        let liked = likes.some((like) => {
                            return like.user === currentUser.id;
                        });
                        return liked;
                    } else {
                        return false;
                    }
                },
                _computeLikeClass (liked) {
                    let baseClass = 'action-button like',
                        activeClass = liked ? 'liked' : 'not-liked';
                    return `${baseClass} ${activeClass}`;
                },
                _computedLikeButtonText (liked) {
                    return liked ? "liked" : "like";
                },
                _computeNavItemClass(section, id) {
                    let baseClass = 'nav-item',
                        activeClass = section === id ? 'active' : 'inactive';
                    return `${baseClass} ${activeClass}`;
                },
                _shareDataChanged(shareDataChangeObj) {
                    let shareData = shareDataChangeObj.base;
                    if (shareData && shareData.id){
                        return this.toggleClass('loaded', true);
                    }
                },
                _showComments() {
                    this.set('_section', 'comments');
                },
                _showLikes() {
                    this.set('_section', 'likes');
                },
                _showCodeButton (shareData) {
                    if(shareData && shareData.attachments &&
                        shareData.attachments.attachment_url)
                    {
                        return true
                    } else {
                        return false;
                    }
                },
                /** Check whether this share can be remixed (or not) */
                _showRemixButton (share) {
                    if (share){
                        return true;
                    }
                },
                _showFeaturedButton (share, isAdmin){
                    return share && isAdmin;
                },

                /** Event listeners */
                _onFeatureTapped () {
                    this.dispatchEvent(new CustomEvent('action-click', {
                        detail: {
                            action: "feature",
                            feature: !this.selectedShare.featured,
                            id: this.selectedShare.id
                        }
                    }));
                },
                _onLikeTapped () {
                    if (this._sharedByUser || this.submitingLike) {
                        return;
                    }
                    if (!this.liked) {
                        let particleBursts = Polymer.dom(this.root)
                                .querySelectorAll('kwc-particle-burst');
                        particleBursts.forEach((burst) => {
                            burst.triggerParticles();
                            window.setTimeout(() => burst.triggerParticles(), 250);
                        })
                    }
                    this.dispatchEvent(new CustomEvent('action-click', {
                        detail: {
                            action: "like",
                            liked: !this.liked,
                            shareId: this.shareData ? this.shareData.id : null,
                            shareUserId: this.shareData ? this.shareData.userId : null,
                            userId: this.currentUser ? this.currentUser.id : null
                        }
                    }));
                },
                _onRemixTapped () {
                    let item = this.shareData;
                    if (!item){return;}

                    this.dispatchEvent(new CustomEvent('action-click', {
                        detail:{
                            action: "remix",
                            shareId: item.id,
                            shareSlug: item.slug,
                            shareType: item.app
                        }
                    }));
                },
                _toggleCodeView() {
                    let newValue = !this.displayCode;
                    this.set('displayCode', newValue);
                },
                _onUserTapped() {
                    let share = this.shareData;
                    if (!share){return;}
                    this.dispatchEvent(new CustomEvent('view-user', {
                        detail: {
                            id: this.shareData.userId,
                            username: this.shareData.username
                        }
                    }));
                },
                _onEmailTapped() {
                    this.dispatchEvent(new CustomEvent('social-share', {
                        detail: {
                            action: 'email',
                            share: this.shareData
                        }
                    }));
                },
                _onFacebookTapped() {
                    this.dispatchEvent(new CustomEvent('social-share', {
                        detail: {
                            action: 'facebook',
                            share: this.shareData
                        }
                    }));
                },
                _onTwitterTapped() {
                    this.dispatchEvent(new CustomEvent('social-share', {
                        detail: {
                            action: 'twitter',
                            share: this.shareData
                        }
                    }));
                },
                _handlePostComment (e) {
                    this.dispatchEvent(new CustomEvent('post-comment', {
                        detail: e.detail
                    }));
                },
                _handleLoadComment (e) {
                    this.dispatchEvent(new CustomEvent('load-comment', {
                        detail: e.detail
                    }));
                },
                _handleFlagComment (e) {
                    this.dispatchEvent(new CustomEvent('flag-comment', {
                        detail: e.detail
                    }));
                },
                _handleViewUser (e) {
                    this.dispatchEvent(new CustomEvent('view-user', {
                        detail: e.detail
                    }));
                }

            });
        })();
    </script>
</dom-module>